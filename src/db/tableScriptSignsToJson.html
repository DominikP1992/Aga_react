<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title></title>
</head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<link rel="stylesheet" href="../library/time/jquery.timepicker.css">
<script src="../library/time/jquery.timepicker.min.js"></script>
<script src="../library/time/datepair.min.js"></script>
<script src="../library/time/jquery.datepair.min.js"></script>




<link rel="stylesheet" href="../css/main.css">

<body>
  <div class="container">
    <ul class="calendar__table">
    </ul>
    <div class="calendar__legend">
      <div class="legend">
        <div class="legend__icon legend__icon--aviable">&#10004;</div>
        <p class="legend__text">Wolny termin</p>
      </div>
      <div class="legend">
        <div class="legend__icon legend__icon--occupied">X</div>
        <p class="legend__text">Zajęty termin</p>
      </div>
      <div class="legend">
        <div class="legend__icon legend__icon--unaviable">―</div>
        <p class="legend__text">Brak zajęć</p>
      </div>
    </div>

    <img src="../img/arrow.png" alt="arrow" class="calendar__arrow calendar__arrow--right">
    <img src="../img/arrow.png" alt="arrow" class="calendar__arrow calendar__arrow--left">




    <!-- <button class="tableJson" style="font-size:40px;">Create JSON</button> -->
  </div>

  <div class="calendar__modal hidden">
    <div class="calendar__change">
      <h1 class="change__title">Zmien status kalendarza</h1>
      <div class="change__day">
        <h2>Dzień</h2>
        <select class="day__value">
          <option value="1">PONIEDZIAŁEK</option>
          <option value="2">WTOREK</option>
          <option value="3">ŚRODA</option>
          <option value="4">CZWARTEK</option>
          <option value="5">PIĄTEK </option>
        </select>
      </div>

      <!-- <div class="change__start">
        <h2>Godzina rozpoczęcia</h2>
        <input type="time" class="start__time" step="900">
      </div>
      <div class="change__end">
        <h2>Godzina zakończenia</h2>
        <input type="time" class="end__time" step="900">
      </div> -->
      <div class="change__time">
        <h2>Pzedział czasowy</h2>
        <input type="text" class="time start" /> to
        <input type="text" class="time end" />
      </div>

      <div class="change__status">
        <h2>Status</h2>
        <select class="status__value">
          <option value="aviable">AVIABLE</option>
          <option value="unaviable">UNAVIABLE</option>
          <option value="occupied">OCCUPIED</option>
        </select>


      </div>

      <div class="change__decision">

        <button class="update__cancel">CANCEL</button>
        <button class="update__trigger">UPDATE CALNEDAR</button>
      </div>
    </div>
  </div>








</body>

<script>
  var container = $(".container");
  var jsonButton = $(".tableJson");
  var table = $(".calendar__table");

  //modal
  var modal = $(".calendar__modal");
  var changeDay = $(".day__value");
  var changeStart = $(".start__time");
  var changeEnd = $(".end__time");

  //calendar update
  var changeStatus = $(".status__value");
  var updateCancel = $(".update__cancel");
  var updateTrigger = $(".update__trigger");
  var tableData = {};
  var dayValue = $(".day__value").children();
  var weekdays = {
      "weekday": [
        "sunday",
        "monday",
        "tuesday",
        "wednesday",
        "thursday",
        "friday",
        "saturday"
      ],
      "weekdayPl": [
        "NIEDZIELA",
        "PONIEDZIAŁEK",
        "WTOREK",
        "ŚRODA",
        "CZWARTEK",
        "PIĄTEK",
        "SOBOTA"
      ],
    }

  // test

  var timeStart = $('.change__time .start');
  var timeEnd = $('.change__time .end');
  var step = 15;
  var minTime = "14:00";
  var maxTime = "21:00";
  timeStart.timepicker({
    'timeFormat': 'H:i',
    'minTime': minTime,
    'maxTime': maxTime,
    'step': step
  });
  timeEnd.timepicker({
    'timeFormat': 'H:i',
    'minTime': minTime,
    'maxTime': maxTime,
    'step': step,
    'showDuration': true,
  });

  $('.change__time').datepair();

  //test
  var methodsInit = function () {
    $(".table__column").on("click", openModal);
    updateCancel.on("click", closeModal);
    updateTrigger.on("click", updateCalendar);
  }
  var addSigns = function (contentHours) {
    var arr = Object.keys(contentHours).map(function (key) {
      return contentHours[key];
    })

    function ifAviable(e) {
      return (e === "aviable");
    }
    function ifUnaviable(e) {
      return (e === "unaviable");
    }
    function ifOccupied(e) {
      return (e === "occupied");
    }

    if (arr.every(ifAviable)) {
      return "&#10004;";
    }
    else if (arr.every(ifUnaviable)) {
      return "―";
    }
    else if (arr.every(ifOccupied)) {
      return "X";
    }
    else {
      return "";
    }
  }

  var updateCalendar = function () {
    var status = changeStatus.val();
    var hourStart = timeStart.val().substring(0, 2);
    var hourEnd = timeEnd.val().substring(0, 2);
    var minuteStart = timeStart.val().substring(3, 5);
    var minuteEnd = timeEnd.val().substring(3, 5);
    var hoursNumber = (hourEnd - hourStart);
    var quarterStart = (minuteStart) / 15;
    var quarterEnd = minuteEnd / 15;
    var quarterNumber = (hoursNumber) * 4 + (quarterEnd - quarterStart);
    var actualDay = changeDay.val();
    actualDay = $(".table__column")[actualDay];
    hoursNumber = (hoursNumber == 0 ? 1 : hoursNumber);
    var actualHour = 0;

    for (var i = hourStart; i <= hourEnd; i++) {
      // actualHour = (i + Number(hourStart));
      actualHour = $(actualDay).find(".column__content > [data-hour = " + i + "] li");

      var addStatus = function (quarterStart, quarterEnd) {

        while (quarterStart <= quarterEnd) {
          $(actualHour[quarterStart]).attr("data-status", status).data("status", status);
          quarterStart++;
        }
      }

      if (hourStart == hourEnd) {
        addStatus(quarterStart, quarterEnd - 1);
      } else if (hourStart != hourEnd && i == hourStart) {
        addStatus(quarterStart, 3)
        quarterNumber = quarterNumber - (4 - quarterStart);

      } else if (hourStart != hourEnd && i != hourStart && quarterNumber > 3) {
        addStatus(0, 3)

        quarterNumber = quarterNumber - 4;
      }
      else if (quarterNumber > 0) {
        addStatus(0, quarterNumber - 1)

      }
    }

    // create json
    var weekDays = $("[data-day]");
    weekDays.each(function (dayIndex) {
      var day = weekdays["weekday"][dayIndex + 1];
      var hours = $(this).find("[data-hour]");
      tableData[day] = {};
      hours.each(function (hourIndex) {
        var hour = "hour_" + $(this).data().hour;
        var quarters = $(this).find("[data-quarter]");
        tableData[day][hour] = {};
        quarters.each(function (quarterIndex) {
          var quarter = "quarter_" + quarterIndex;
          var x = $(this).data().status;
          tableData[day][hour][quarter] = $(this).data().status;
        })
        tableData[day][hour]["sign"] = addSigns(tableData[day][hour]);
      });
    })

    $.ajax({
      url: 'http://localhost:3000/table',
      type: 'POST',
      data: JSON.stringify(tableData),
      contentType: 'application/json; charset=utf-8',
      dataType: 'json',
      async: false,
      success: function (res) {
        console.log("kalendarz zaktualizowany");
        closeModal();
        createCalendar(res);
        
      },
      error: function (res) {
        console.log("Nie udało się zaktualizowac kalendarza");
        closeModal();
      }
    });
  }
  var closeModal = function () {

    container.removeClass("modal--on");
    modal.addClass("hidden");
  }
  var openModal = function (e) {
    var currentDay = $(e.currentTarget).data().day - 1;
    var currentQuarter = $(e.target).data().quarter;
    var currentHour = $(e.target).parent().parent().data().hour;
    var currentTime = "";
    switch (currentQuarter) {
      case 0:
        currentQuarter = ":00"
        break;
      case 1:
        currentQuarter = ":15"
        break;
      case 2:
        currentQuarter = ":30"
        break;
      case 3:
        currentQuarter = ":45"
        break;
      default:
    }
    currentTime = currentHour + currentQuarter;
    timeStart.timepicker('setTime', currentTime);
    $(dayValue[currentDay]).attr("selected", true);
    container.addClass("modal--on");
    modal.removeClass("hidden");
  }



  var createCalendar = function (tableData) {
    table.children().remove()
    var day = "";
    var dayPl = "";
    var hour = "";
    var quarter = "";
    

    table.append(
      `
      <li class="table__column table__column--time">
      <ul class="column__content">
        <li data-hour="">14:00</li>
        <li data-hour="">15:00</li>
        <li data-hour="">16:00</li>
        <li data-hour="">17:00</li>
        <li data-hour="">18:00</li>
        <li data-hour="">19:00</li>
        <li data-hour="">20:00</li>
      </ul>
    </li>`
    );
    for (var i = 1; i <= 5; i++) {
      day = weekdays["weekday"][i];
      dayPl = weekdays["weekdayPl"][i];
      table.append("<li class='table__column table__column--" + day + "' data-day=" + i + "></li>");
      $("[data-day=" + i + "]").append("<div class='column__header'>" + dayPl + "</div><ul class='column__content'></ul>");
      for (var j = 14; j <= 20; j++) {
        hour = "hour_" + j;
        var sign = tableData[day][hour]["sign"];
        var iconClass = "";
        if (sign === "―") {
          iconClass = "hour__icon--center";
        }
        $("[data-day=" + i + "] > ul").append("<li data-hour=" + j + "><ul class='content__hour'><span class='hour__icon " + iconClass + "'>" + sign + "</span></ul></li>");
        for (var k = 0; k < 4; k++) {
          quarter = "quarter_" + k;
          $("[data-day=" + i + "] > ul > [data-hour=" + j + "] > ul").append("<li data-quarter=" + k + " data-status=" + tableData[day][hour][quarter] + "></li>");
        }
      }
    }
    methodsInit();
  }

  //get data table data
  $.ajax({
    url: 'http://localhost:3000/table/',
    method: 'GET'
  })
    .done(function (response) {
      tableData = response;
      createCalendar(tableData);
    })
    .fail(function (error) {
      console.log('Błąd serwera');
    })
</script>

</html>